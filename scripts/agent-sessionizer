#!/usr/bin/env bash
# agent-sessionizer - Create and manage sandboxed agent VMs
#
# Usage:
#   agent-sessionizer              # Interactive fzf selection
#   agent-sessionizer owner/repo   # Direct repo specification
#   agent-sessionizer --list       # List running VMs
#   agent-sessionizer --stop NAME  # Stop a VM
#   agent-sessionizer --destroy NAME  # Destroy a VM
#   agent-sessionizer --shell NAME # Shell into a VM

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SANDBOX_DIR="$(dirname "$SCRIPT_DIR")"
CONFIG_DIR="$SANDBOX_DIR/config"
LIMA_DIR="$SANDBOX_DIR/lima"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[OK]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Generate a short random suffix for VM names
generate_suffix() {
    head -c 4 /dev/urandom | xxd -p
}

# Convert repo name to valid VM name (e.g., "owner/repo" -> "owner-repo")
repo_to_vm_name() {
    local repo="$1"
    local suffix="$2"
    echo "agent-$(echo "$repo" | tr '/' '-' | tr '[:upper:]' '[:lower:]')-${suffix}"
}

# Get list of running agent VMs
list_running_vms() {
    limactl list --format '{{.Name}} {{.Status}}' 2>/dev/null | grep '^agent-' | grep 'Running' | awk '{print $1}' || true
}

# Get list of all agent VMs (running or stopped)
list_all_vms() {
    limactl list --format '{{.Name}} {{.Status}}' 2>/dev/null | grep '^agent-' || true
}

# Check if Lima is installed
check_lima() {
    if ! command -v limactl &> /dev/null; then
        log_error "Lima is not installed. Install with: brew install lima"
        exit 1
    fi
}

# Check if required tools are available
check_dependencies() {
    local missing=()
    for cmd in fzf; do
        if ! command -v "$cmd" &> /dev/null; then
            missing+=("$cmd")
        fi
    done

    if [ ${#missing[@]} -gt 0 ]; then
        log_error "Missing dependencies: ${missing[*]}"
        log_info "Install with: brew install ${missing[*]}"
        exit 1
    fi
}

# Helper to run commands in VM without host proxy settings
vm_run() {
    local vm_name="$1"
    shift
    limactl shell "$vm_name" -- env -u http_proxy -u https_proxy -u HTTP_PROXY -u HTTPS_PROXY bash -c "$*"
}

# Create a new VM for a repo
create_vm() {
    local repo="$1"
    local suffix=$(generate_suffix)
    local vm_name=$(repo_to_vm_name "$repo" "$suffix")
    local has_token=false

    log_info "Creating VM: $vm_name for repo: $repo"

    # Check for GitHub token (optional - needed for private repos and pushing)
    if [ -z "$GITHUB_TOKEN" ]; then
        # Try to get from 1Password if available
        if command -v op &> /dev/null; then
            log_info "Attempting to get GitHub token from 1Password..."
            GITHUB_TOKEN=$(op read "op://Private/GitHub PAT Agent/token" 2>/dev/null) || true
        fi
    fi

    if [ -n "$GITHUB_TOKEN" ]; then
        has_token=true
    else
        log_warn "GITHUB_TOKEN not set. Cloning as public repo (no push/PR access)."
        log_info "For private repos or to push, set GITHUB_TOKEN"
    fi

    # Start the VM
    log_info "Starting Lima VM (this may take a few minutes on first run)..."
    limactl start --name="$vm_name" "$LIMA_DIR/agent-sandbox.yaml"

    # Wait for VM to be ready
    log_info "Waiting for VM to be ready..."
    sleep 5

    # Configure GitHub auth if token is available
    if [ "$has_token" = true ]; then
        log_info "Configuring GitHub authentication..."
        vm_run "$vm_name" "echo 'export GITHUB_TOKEN=${GITHUB_TOKEN}' >> ~/.zshenv"
        vm_run "$vm_name" "export GITHUB_TOKEN=${GITHUB_TOKEN} && gh auth setup-git"

        # Clone using gh (works with private repos)
        log_info "Cloning repository: $repo"
        vm_run "$vm_name" "cd ~/workspace && export GITHUB_TOKEN=${GITHUB_TOKEN} && gh repo clone '$repo' repo"
    else
        # Clone using git (public repos only)
        log_info "Cloning public repository: $repo"
        vm_run "$vm_name" "cd ~/workspace && git clone 'https://github.com/$repo.git' repo"
    fi

    # Store repo name in VM for reference
    vm_run "$vm_name" "echo '$repo' > ~/workspace/.repo-name"

    log_success "VM $vm_name created and configured"
    echo ""
    log_info "To connect: limactl shell $vm_name"
    log_info "Workspace:  ~/workspace/repo"
}

# Shell into a VM
shell_vm() {
    local vm_name="$1"

    if [ -z "$vm_name" ]; then
        log_error "VM name required"
        exit 1
    fi

    exec limactl shell "$vm_name"
}

# Stop a VM
stop_vm() {
    local vm_name="$1"

    if [ -z "$vm_name" ]; then
        log_error "VM name required"
        exit 1
    fi

    log_info "Stopping VM: $vm_name"
    limactl stop "$vm_name"
    log_success "VM stopped: $vm_name"
}

# Destroy a VM
destroy_vm() {
    local vm_name="$1"

    if [ -z "$vm_name" ]; then
        log_error "VM name required"
        exit 1
    fi

    log_warn "Destroying VM: $vm_name (this will delete all data)"
    read -p "Are you sure? (y/N) " -n 1 -r
    echo

    if [[ $REPLY =~ ^[Yy]$ ]]; then
        limactl delete -f "$vm_name"
        log_success "VM destroyed: $vm_name"
    else
        log_info "Cancelled"
    fi
}

# Show interactive selection
interactive_select() {
    local repos_file="$CONFIG_DIR/repos.txt"

    if [ ! -f "$repos_file" ]; then
        log_error "Repos config not found: $repos_file"
        log_info "Create it with one repo per line (e.g., owner/repo)"
        exit 1
    fi

    # Build selection list: running VMs first, then repos
    local selection_list=""

    # Add running VMs
    local running_vms=$(list_running_vms)
    if [ -n "$running_vms" ]; then
        for vm in $running_vms; do
            # Get repo name from VM
            local repo=$(vm_run "$vm" "cat ~/workspace/.repo-name 2>/dev/null" || echo "unknown")
            selection_list+="[RUNNING] $repo ($vm)"$'\n'
        done
        selection_list+="─────────────────────────────────"$'\n'
    fi

    # Add repos from config
    while IFS= read -r repo || [ -n "$repo" ]; do
        # Skip comments and empty lines
        [[ "$repo" =~ ^#.*$ ]] && continue
        [[ -z "$repo" ]] && continue
        selection_list+="$repo"$'\n'
    done < "$repos_file"

    # Show fzf selection
    local selected=$(echo -e "$selection_list" | fzf --header="Select repo or running VM" --height=40%)

    if [ -z "$selected" ]; then
        exit 0
    fi

    # Handle selection
    if [[ "$selected" == "─"* ]]; then
        # Separator line selected, ignore
        exit 0
    elif [[ "$selected" == "[RUNNING]"* ]]; then
        # Extract VM name from selection and shell into it
        local vm_name=$(echo "$selected" | grep -o '(agent-[^)]*)')
        vm_name="${vm_name:1:-1}"  # Remove parentheses
        shell_vm "$vm_name"
    else
        # New repo selected
        create_vm "$selected"
    fi
}

# Main
main() {
    check_lima
    check_dependencies

    case "${1:-}" in
        --list|-l)
            echo "Agent VMs:"
            list_all_vms
            ;;
        --stop|-s)
            stop_vm "$2"
            ;;
        --destroy|-d)
            destroy_vm "$2"
            ;;
        --shell|-sh)
            shell_vm "$2"
            ;;
        --help|-h)
            echo "Usage: agent-sessionizer [OPTIONS] [REPO]"
            echo ""
            echo "Options:"
            echo "  --list, -l          List all agent VMs"
            echo "  --stop, -s NAME     Stop a VM"
            echo "  --destroy, -d NAME  Destroy a VM"
            echo "  --shell, -sh NAME   Shell into a VM"
            echo "  --help, -h          Show this help"
            echo ""
            echo "Examples:"
            echo "  agent-sessionizer                    # Interactive selection"
            echo "  agent-sessionizer owner/repo         # Create VM for specific repo"
            echo "  agent-sessionizer --list             # List running VMs"
            echo "  agent-sessionizer --shell agent-foo-abc123"
            echo "  agent-sessionizer --destroy agent-foo-abc123"
            ;;
        "")
            interactive_select
            ;;
        *)
            # Assume it's a repo name
            create_vm "$1"
            ;;
    esac
}

main "$@"
