# Agent Sandbox VM Configuration
# Usage: limactl start --name=agent-foo ./agent-sandbox.yaml

# Don't inherit proxy settings from host (can break apt, git, etc.)
propagateProxyEnv: false

# Use Apple Virtualization framework for better performance on ARM Macs
vmType: vz
vmOpts:
  vz:
    rosetta:
      enabled: true
      binfmt: true

# Resource defaults - can be overridden via limactl start --cpus, --memory, --disk
cpus: 4
memory: 8GiB
disk: 50GiB

# Ubuntu 24.04 LTS cloud images
images:
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img"
    arch: "aarch64"
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-amd64.img"
    arch: "x86_64"

# CRITICAL: No host filesystem mounts for isolation
mounts: []

# SSH configuration
ssh:
  localPort: 0              # Auto-assign port to avoid conflicts between VMs
  forwardAgent: false       # Don't expose host SSH agent to VM

# We use Docker, not containerd
containerd:
  system: false
  user: false

# Network: use vzNAT for isolated networking
networks:
  - vzNAT: true

# Provisioning scripts run on first boot
provision:
  # System-level provisioning (runs as root)
  - mode: system
    script: |
      #!/bin/bash
      set -eux

      # Unset proxy vars that Lima may have inherited from host
      unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY

      export DEBIAN_FRONTEND=noninteractive

      # Get the non-root user (Lima syncs UID from macOS host, so find user with /home dir)
      LIMA_USER=$(awk -F: '$6 ~ /^\/home/ && $1 != "root" {print $1; exit}' /etc/passwd)

      # Switch apt sources to HTTPS (fixes issues with HTTP proxies)
      sed -i 's|http://|https://|g' /etc/apt/sources.list.d/ubuntu.sources 2>/dev/null || \
        sed -i 's|http://|https://|g' /etc/apt/sources.list 2>/dev/null || true

      # Update package lists
      apt-get update

      # Install base dependencies
      apt-get install -y \
        curl \
        wget \
        git \
        vim \
        tmux \
        zsh \
        jq \
        unzip \
        build-essential \
        ca-certificates \
        gnupg \
        lsb-release \
        iptables \
        dnsmasq

      # Install Docker
      install -m 0755 -d /etc/apt/keyrings
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      chmod a+r /etc/apt/keyrings/docker.gpg
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" > /etc/apt/sources.list.d/docker.list
      apt-get update
      apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

      # Add Lima user to docker group
      usermod -aG docker "$LIMA_USER"

      # Install GitHub CLI
      curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
      chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" > /etc/apt/sources.list.d/github-cli.list
      apt-get update
      apt-get install -y gh

      # Install lazygit (detect architecture)
      LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | jq -r '.tag_name' | sed 's/v//')
      ARCH=$(dpkg --print-architecture)
      if [ "$ARCH" = "arm64" ]; then
        LAZYGIT_ARCH="arm64"
      else
        LAZYGIT_ARCH="x86_64"
      fi
      curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_${LAZYGIT_ARCH}.tar.gz"
      tar xf lazygit.tar.gz lazygit
      install lazygit /usr/local/bin
      rm -f lazygit lazygit.tar.gz

      # Install Playwright system dependencies
      apt-get install -y \
        libnss3 \
        libnspr4 \
        libatk1.0-0 \
        libatk-bridge2.0-0 \
        libcups2 \
        libdrm2 \
        libxkbcommon0 \
        libxcomposite1 \
        libxdamage1 \
        libxfixes3 \
        libxrandr2 \
        libgbm1 \
        libasound2t64 \
        libpango-1.0-0 \
        libcairo2

      # Setup iptables for port filtering (allow only 80, 443, 22 outbound)
      cat > /etc/rc.local << 'EOF'
      #!/bin/bash
      iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
      iptables -A OUTPUT -o lo -j ACCEPT
      iptables -A OUTPUT -p udp --dport 53 -j ACCEPT
      iptables -A OUTPUT -p tcp --dport 53 -j ACCEPT
      iptables -A OUTPUT -p tcp --dport 80 -j ACCEPT
      iptables -A OUTPUT -p tcp --dport 443 -j ACCEPT
      iptables -A OUTPUT -p tcp --dport 22 -j ACCEPT
      iptables -A OUTPUT -j DROP
      exit 0
      EOF
      chmod +x /etc/rc.local
      /etc/rc.local

      echo "System provisioning complete"

  # User-level provisioning (runs as lima user)
  - mode: user
    script: |
      #!/bin/bash
      set -ex  # Note: no -u flag, nvm has unbound variables

      # Unset proxy vars that Lima may have inherited from host
      unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY

      # Create directories first
      mkdir -p ~/workspace
      mkdir -p ~/.local/bin

      # Install nvm and Node.js
      curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
      nvm install --lts
      nvm use --lts

      # Install Claude Code
      npm install -g @anthropic-ai/claude-code

      # Set zsh as default shell
      sudo chsh -s $(which zsh) $(whoami)

      # Write .zshrc
      {
        echo '# Agent Sandbox ZSH Config'
        echo 'export EDITOR=vim'
        echo 'export VISUAL=vim'
        echo ''
        echo '# NVM'
        echo 'export NVM_DIR="$HOME/.nvm"'
        echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"'
        echo '[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"'
        echo ''
        echo '# Local bin'
        echo 'export PATH="$HOME/.local/bin:$PATH"'
        echo ''
        echo '# Aliases'
        echo 'alias ll="ls -la"'
        echo 'alias gs="git status"'
        echo 'alias gd="git diff"'
        echo 'alias gc="git commit"'
        echo 'alias gp="git push"'
        echo 'alias gl="git pull"'
        echo ''
        echo '# Prompt'
        echo "PROMPT='%F{green}[agent]%f %F{blue}%~%f %# '"
      } > ~/.zshrc

      # Write .tmux.conf
      {
        echo 'set -g mouse on'
        echo 'set -g base-index 1'
        echo 'set -s escape-time 0'
        echo 'set-window-option -g mode-keys vi'
        echo ''
        echo '# Prefix: Ctrl+a'
        echo 'unbind C-b'
        echo 'set-option -g prefix C-a'
        echo 'bind-key C-a send-prefix'
        echo ''
        echo '# Split panes'
        echo 'bind | split-window -h'
        echo 'bind - split-window -v'
        echo ''
        echo '# Status bar'
        echo 'set -g status-left-length 40'
        echo 'set -g status-left "[#S] "'
      } > ~/.tmux.conf

      # Write ready-tmux script
      {
        echo '#!/bin/bash'
        echo '# Setup tmux windows for agent workflow'
        echo ''
        echo '# If not in tmux, start a new session and run setup'
        echo 'if [ -z "$TMUX" ]; then'
        echo '  tmux new-session -d -s agent -c ~/workspace/repo'
        echo '  TMUX_STARTED=1'
        echo 'fi'
        echo ''
        echo '# Setup windows'
        echo 'tmux rename-window "vim"'
        echo 'tmux send-keys "cd ~/workspace/repo && vim ." C-m'
        echo 'tmux new-window -n "server" -c ~/workspace/repo'
        echo 'tmux new-window -n "claude" -c ~/workspace/repo'
        echo 'tmux send-keys "claude --dangerously-skip-permissions" C-m'
        echo 'tmux new-window -n "git" -c ~/workspace/repo'
        echo 'tmux send-keys "lazygit" C-m'
        echo 'tmux new-window -n "scratch" -c ~/workspace/repo'
        echo 'tmux select-window -t "claude"'
        echo ''
        echo '# If we started tmux, attach to it'
        echo 'if [ -n "$TMUX_STARTED" ]; then'
        echo '  exec tmux attach -t agent'
        echo 'fi'
      } > ~/.local/bin/ready-tmux
      chmod +x ~/.local/bin/ready-tmux

      echo "User provisioning complete"

# Message shown after VM starts
message: |
  Agent sandbox VM is ready!
  To connect: limactl shell {{.Name}}
  Workspace directory: ~/workspace
